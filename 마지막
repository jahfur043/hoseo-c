#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

#define MAX 5
#define DATA_FILE "product_inventory.bin"

typedef struct {
    int id;
    char name[50];
    int price;
    int stock;
    int sales;
    long long totalSales;
} Product;

Product products[MAX];
int count = 0;

void clear_input_buffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

int findProduct(Product p[], int current_count, int id) {
    for (int i = 0; i < current_count; i++) {
        if (p[i].id == id) return i;
    }
    return -1;
}

void save_inventory() {
    FILE *fp = fopen(DATA_FILE, "wb");
    if (fp == NULL) {
        printf("âŒ íŒŒì¼ ì €ì¥ ì˜¤ë¥˜: %s íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n", DATA_FILE);
        return;
    }

    fwrite(&count, sizeof(int), 1, fp);
    fwrite(products, sizeof(Product), count, fp);

    fclose(fp);
    printf("âœ… í˜„ì¬ ìƒí’ˆ ì •ë³´ %dê°œë¥¼ íŒŒì¼ì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.\n", count);
}

void load_inventory() {
    FILE *fp = fopen(DATA_FILE, "rb");

    if (fp == NULL) {
        printf("ğŸ’¡ ì €ì¥ëœ íŒŒì¼ì´ ì—†ì–´ ìƒˆ ì¸ë²¤í† ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\n");
        return;
    }

    if (fread(&count, sizeof(int), 1, fp) != 1) {
        printf("âŒ íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜: ìƒí’ˆ ê°œìˆ˜ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n");
        fclose(fp);
        count = 0;
        return;
    }

    if (fread(products, sizeof(Product), count, fp) != count) {
        printf("âŒ íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜: ìƒí’ˆ ë°ì´í„°ë¥¼ ëª¨ë‘ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n");
        fclose(fp);
        count = 0;
        return;
    }

    fclose(fp);
    printf("âœ… ìƒí’ˆ ì •ë³´ %dê°œë¥¼ íŒŒì¼ì—ì„œ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.\n", count);
}

int main() {
    int menu;
    
    load_inventory();

    while (1) {
        printf("\nì›í•˜ëŠ” ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”.\n");
        printf("1. ì…ê³ \n2. íŒë§¤\n3. ê°œë³„í˜„í™©\n4. ì „ì²´í˜„í™©\n5. ì¢…ë£Œ\n>> ");
        
        if (scanf("%d", &menu) != 1) {
            printf("âŒ ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n");
            clear_input_buffer();
            continue;
        }
        clear_input_buffer();

        if (menu == 1) {
            int id, quantity, price;
            char name[50];
            
            printf("ìƒí’ˆ ID ì…ë ¥: ");
            if (scanf("%d", &id) != 1) {
                printf("âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ì…ë‹ˆë‹¤.\n");
                clear_input_buffer();
                continue;
            }
            clear_input_buffer();
            
            int index = findProduct(products, count, id);

            if (index == -1) {
                if (count >= MAX) {
                    printf("âŒ ìƒí’ˆ ê°œìˆ˜ ì´ˆê³¼! (ìµœëŒ€ %dê°œ)\n", MAX);
                    continue;
                }
                
                printf("ìƒí’ˆëª… ì…ë ¥: ");
                if (fgets(name, 50, stdin) == NULL) {
                    printf("âŒ ìƒí’ˆëª… ì…ë ¥ ì˜¤ë¥˜.\n");
                    continue;
                }
                name[strcspn(name, "\n")] = 0;

                printf("ì…ê³ ëŸ‰ ì…ë ¥: ");
                if (scanf("%d", &quantity) != 1 || quantity <= 0) {
                    printf("âŒ ì…ê³ ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.\n");
                    clear_input_buffer();
                    continue;
                }
                clear_input_buffer();

                printf("íŒë§¤ê°€ê²© ì…ë ¥: ");
                if (scanf("%d", &price) != 1 || price <= 0) {
                    printf("âŒ íŒë§¤ê°€ê²©ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.\n");
                    clear_input_buffer();
                    continue;
                }
                clear_input_buffer();

                products[count].id = id;
                strcpy(products[count].name, name);
                products[count].price = price;
                products[count].stock = quantity;
                products[count].sales = 0;
                products[count].totalSales = 0;
                count++;
                printf("âœ… ì‹ ê·œ ìƒí’ˆ ë“±ë¡ ë° ì…ê³  ì™„ë£Œ!\n");
            } else {
                printf("ğŸ“¢ ê¸°ì¡´ ìƒí’ˆ (%s) ì…ë‹ˆë‹¤. ì…ê³ ëŸ‰ ì¶”ê°€ ì…ë ¥: ", products[index].name);
                if (scanf("%d", &quantity) != 1 || quantity <= 0) {
                    printf("âŒ ì…ê³ ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.\n");
                    clear_input_buffer();
                    continue;
                }
                clear_input_buffer();
                
                products[index].stock += quantity;
                printf("âœ… ì…ê³ ëŸ‰ %d ì¶”ê°€ ì™„ë£Œ! (í˜„ì¬ ì¬ê³ : %d)\n", quantity, products[index].stock);
            }
            save_inventory();

        }
        
        else if (menu == 2) {
            int id, qty;
            
            printf("ìƒí’ˆ ID ì…ë ¥: ");
            if (scanf("%d", &id) != 1) {
                printf("âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ì…ë‹ˆë‹¤.\n");
                clear_input_buffer();
                continue;
            }
            clear_input_buffer();
            
            int index = findProduct(products, count, id);

            if (index == -1) {
                printf("âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìƒí’ˆì…ë‹ˆë‹¤.\n");
                continue;
            }

            printf("íŒë§¤ ìˆ˜ëŸ‰ ì…ë ¥ (í˜„ì¬ ì¬ê³ : %d): ", products[index].stock);
            if (scanf("%d", &qty) != 1 || qty <= 0) {
                printf("âŒ íŒë§¤ ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.\n");
                clear_input_buffer();
                continue;
            }
            clear_input_buffer();

            if (qty > products[index].stock) {
                printf("âŒ ì¬ê³  ë¶€ì¡±! (ìš”ì²­: %d, ì¬ê³ : %d)\n", qty, products[index].stock);
            } else {
                products[index].stock -= qty;
                products[index].sales += qty;
                products[index].totalSales += (long long)qty * products[index].price;
                printf("âœ… íŒë§¤ ì™„ë£Œ! (íŒë§¤ ê¸ˆì•¡: %lld)\n", (long long)qty * products[index].price);
            }
            save_inventory();
        }

        else if (menu == 3) {
            int id;
            
            printf("ìƒí’ˆ ID ì…ë ¥: ");
            if (scanf("%d", &id) != 1) {
                printf("âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì…ë ¥ì…ë‹ˆë‹¤.\n");
                clear_input_buffer();
                continue;
            }
            clear_input_buffer();
            
            int index = findProduct(products, count, id);

            if (index == -1) {
                printf("âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìƒí’ˆì…ë‹ˆë‹¤.\n");
            } else {
                printf("\n--- ê°œë³„ìƒí’ˆí˜„í™© ---\n");
                printf("ID: %d\n", products[index].id);
                printf("ìƒí’ˆëª…: %s\n", products[index].name);
                printf("ê°€ê²©: %d\n", products[index].price);
                printf("ì¬ê³ : %d\n", products[index].stock);
                printf("íŒë§¤ëŸ‰: %d\n", products[index].sales);
                printf("ì´íŒë§¤ê¸ˆì•¡: %lld\n", products[index].totalSales);
                printf("----------------------\n");
            }
        }

        else if (menu == 4) {
            printf("\n--- ì „ì²´ìƒí’ˆí˜„í™© ---\n");
            if (count == 0) {
                printf("ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.\n");
                continue;
            }
            printf("========================================================================\n");
            printf("ID\tìƒí’ˆëª…\t\tê°€ê²©\tì¬ê³ \tíŒë§¤ëŸ‰\tì´íŒë§¤ê¸ˆì•¡\n");
            printf("========================================================================\n");
            for (int i = 0; i < count; i++) {
                printf("%d\t%-15s\t%d\t%d\t%d\t%lld\n",
                    products[i].id, products[i].name, products[i].price,
                    products[i].stock, products[i].sales, products[i].totalSales);
            }
            printf("------------------------------------------------------------------------\n");
        }

        else if (menu == 5) {
            save_inventory();
            printf("ğŸ‘‹ í”„ë¡œê·¸ë¨ ì¢…ë£Œ.\n");
            break;
        }

        else {
            printf("âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.\n");
        }
    }

    return 0;
}
